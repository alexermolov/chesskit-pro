# Система веток для анализа шахматных ходов

## Обзор

Система веток позволяет анализировать множественные варианты ходов в шахматной партии, создавая древовидную структуру для глубокого тактического анализа.

## Ключевые компоненты

### 1. Структуры данных
- **`MoveTree`** - основная структура дерева ходов
- **`MoveTreeNode`** - узел дерева, представляющий один ход
- **`MoveTreeUtils`** - утилиты для работы с деревом

### 2. Хуки
- **`useChessActionsWithBranches`** - основной хук для работы с ветками
- Совместим с существующим `useChessActionsWithHistory`

### 3. UI компоненты
- **`BranchesMovesPanel`** - панель отображения ходов с ветками
- **`BranchMoveItem`** - отдельный элемент хода
- **`BranchManager`** - управление ветками

## Функциональность

### Создание веток
- Автоматическое создание новой ветки при альтернативном ходе
- Возможность форсированного создания ветки (`createNewBranch: true`)

### Навигация
- Переключение между ветками
- Навигация по истории ходов в рамках ветки
- Поиск альтернативных ходов

### Управление
- **Ctrl+B** - переключение между линейным и древовидным режимами
- **ПКМ** на кнопках навигации - контекстные меню с альтернативами
- Визуальные индикаторы активного режима

## Интеграция

### Панель ходов
- Переключатель режимов в `MovesPanel`
- Отображение веток и альтернативных ходов
- Chip-элементы для быстрого переключения между ветками

### Кнопки навигации
- **Undo/Redo** - поддержка веток с контекстными меню
- **Next Move** - учёт альтернативных ходов
- Сохранение совместимости с линейным режимом

## Использование

1. **Включение режима веток**: используйте переключатель в панели ходов или `Ctrl+B`
2. **Создание ветки**: сделайте альтернативный ход в любой позиции
3. **Навигация**: используйте chip-элементы или правый клик на кнопках навигации
4. **Переключение веток**: кликните на chip нужной ветки в панели ходов

## Совместимость

Система полностью совместима с существующим кодом:
- Линейный режим работает как прежде
- Все существующие функции сохранены
- Плавное переключение между режимами

## Файлы

### Основные
- `src/types/moveTree.ts` - типы и утилиты
- `src/hooks/useChessActionsWithBranches.ts` - хук для веток
- `src/sections/analysis/states.ts` - состояние дерева ходов

### UI компоненты
- `src/sections/analysis/panelBody/classificationTab/movesPanel/branchesMovesPanel.tsx`
- `src/sections/analysis/panelBody/classificationTab/movesPanel/branchMoveItem.tsx`
- `src/components/BranchManager.tsx`

### Обновлённые компоненты
- `src/sections/analysis/panelToolbar/index.tsx` - панель инструментов
- `src/sections/analysis/panelToolbar/redoMoveButton.tsx` - кнопка повтора
- `src/sections/analysis/panelToolbar/nextMoveButton.tsx` - следующий ход
- `src/sections/analysis/panelBody/classificationTab/movesPanel/index.tsx` - панель ходов

## Технические детали

- Атомарное состояние через Jotai (`moveTreeAtom`)
- TypeScript с полной типизацией
- Синхронизация между линейным Chess.js и древовидной структурой
- Оптимизированные операции с деревом через мемоизацию
