# Система истории ходов в ChessKit Pro

## Обзор

Добавлена система истории ходов, которая позволяет пользователям отменять и повторять ходы без потери данных. Теперь отмененные ходы сохраняются в истории и могут быть восстановлены.

## Ключевые изменения

### 1. Новый хук `useChessActionsWithHistory`

Расширенная версия `useChessActions` с поддержкой истории:

- **Отмена ходов**: `undoMove()` - отменяет последний ход
- **Повтор ходов**: `redoMove()` - восстанавливает отмененный ход
- **Проверка состояния**: `canUndo`, `canRedo` - показывает доступность операций
- **Информация об истории**: `moveHistory`, `currentPosition`

### 2. Новые компоненты

#### `RedoMoveButton` (Анализ)
- Кнопка для повтора отмененных ходов в секции анализа
- Горячие клавиши: Ctrl+Y, Ctrl+Shift+Z
- Интегрирована в панель инструментов анализа

#### `RedoMoveButton` (Игра)
- Кнопка для повтора ходов в секции игры
- Добавлена рядом с кнопкой отмены хода

### 3. Обновленные компоненты

#### `PanelToolBar` (Анализ)
- Использует новый хук с историей
- Добавлена поддержка Ctrl+Z для отмены
- Интегрирована кнопка повтора ходов

#### `NextMoveButton`
- Теперь приоритизирует повтор отмененных ходов
- Если есть отмененные ходы, сначала повторяет их
- Только после этого добавляет новые ходы из игры

#### `UndoMoveButton` (Игра)
- Обновлен для использования нового хука
- Показывает состояние доступности отмены

## Горячие клавиши

- **Ctrl+Z** - Отменить ход
- **Ctrl+Y** - Повторить ход
- **Ctrl+Shift+Z** - Повторить ход (альтернативная комбинация)
- **Стрелка влево** - Отменить ход (в анализе)
- **Стрелка вправо** - Следующий ход / Повтор (в анализе)

## Как это работает

### Структура истории

```typescript
interface MoveHistory {
  allMoves: Move[];       // Все когда-либо сделанные ходы
  currentPosition: number; // Текущая позиция в истории (-1 = начальная позиция)
}
```

### Пример работы

1. **Начальное состояние**: `allMoves: [], currentPosition: -1`
2. **После хода e4**: `allMoves: [e4], currentPosition: 0`
3. **После хода e5**: `allMoves: [e4, e5], currentPosition: 1`
4. **После отмены**: `allMoves: [e4, e5], currentPosition: 0` (e5 отменен, но сохранен)
5. **После повтора**: `allMoves: [e4, e5], currentPosition: 1` (e5 восстановлен)
6. **Новый ход d4**: `allMoves: [e4, d4], currentPosition: 1` (e5 заменен на d4)

### Логика навигации

- **Отмена**: Уменьшает `currentPosition`, игра восстанавливается до соответствующей позиции
- **Повтор**: Увеличивает `currentPosition`, применяется следующий ход из истории
- **Новый ход**: Обрезает историю после текущей позиции и добавляет новый ход

## Преимущества

1. **Пользовательский опыт**: Отмененные ходы не теряются навсегда
2. **Привычные горячие клавиши**: Ctrl+Z/Ctrl+Y как в других приложениях
3. **Гибкость**: Можно экспериментировать с вариантами, не теряя прогресс
4. **Совместимость**: Полностью совместимо с существующим функционалом

## Демо компонент

Создан `MoveHistoryDemo` для тестирования функциональности:
- Показывает текущее состояние истории
- Кнопки для тестирования отмены/повтора
- Визуальное отображение истории ходов
- Инструкции по использованию

## Интеграция

Для использования в существующих компонентах:

```typescript
// Вместо useChessActions
import { useChessActionsWithHistory } from "@/hooks/useChessActionsWithHistory";

const {
  playMove,
  undoMove,
  redoMove,    // Новая функция
  canUndo,     // Новое свойство
  canRedo,     // Новое свойство
  // ... остальные функции остаются теми же
} = useChessActionsWithHistory(chessAtom);
```

## Будущие улучшения

1. **Ветвление истории**: Поддержка нескольких веток ходов
2. **Сохранение истории**: Сохранение истории между сессиями
3. **Анимации**: Плавные переходы при отмене/повторе ходов
4. **Метаданные**: Сохранение времени и комментариев к ходам
